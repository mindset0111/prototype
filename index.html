<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT Customer Support - Submit Enquiry Prototype (Amazon Style)</title>
    <style>
        body {
            font-family: "Amazon Ember", Arial, sans-serif; /* Prefer Amazon Ember if available, fallback to Arial */
            margin: 0; /* Remove default body margin */
            background-color: #EAEDED; /* Light Amazon background */
            color: #0F1111; /* Dark Amazon text color */
        }
        .container {
            max-width: 800px;
            margin: 20px auto; /* Centered with top/bottom margin */
            background-color: #FFFFFF; /* White background for the form itself */
            padding: 30px 40px; /* More padding */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); /* Subtle Amazon-like shadow */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        h1 {
            font-size: 28px; /* Slightly larger heading */
            color: #0F1111; /* Dark text for headings */
            margin-bottom: 5px;
            font-weight: 500; /* Medium weight */
        }
        p.intro {
            font-size: 0.95em; /* Slightly larger intro text */
            color: #565959; /* Muted grey for secondary text */
            margin-bottom: 25px;
        }
        .section-header {
            font-size: 1.15em; /* Slightly smaller section headers */
            font-weight: bold;
            color: #0F1111;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #E3E6E6; /* Lighter border */
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px; /* More space for labels */
            font-weight: bold;
            color: #0F1111;
            font-size: 0.9em; /* Slightly smaller label text */
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        textarea,
        select,
        input[type="password"] { /* Added password input here */
            width: 100%; /* Full width */
            padding: 8px 10px; /* Consistent padding */
            border: 1px solid #D5D9D9; /* Amazon input border color */
            border-radius: 3px; /* Slightly less rounded */
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
            outline: none; /* Remove default outline */
            box-shadow: 0 0 0 0px #F7FEFF; /* Start with no focus shadow */
            transition: border-color 0.2s, box-shadow 0.2s; /* Smooth transition */
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus,
        input[type="password"]:focus { /* Added password input here */
            border-color: #E77600; /* Orange border on focus */
            box-shadow: 0 0 0 3px #F90; /* Orange glow on focus */
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .conditional-field {
            display: none;
            background-color: #F7FAFC; /* Lighter background for conditional */
            padding: 15px;
            border: 1px solid #D5D9D9; /* Subtle border */
            border-radius: 4px;
            margin-top: 15px;
        }
        .order-status-box, .info-box, .live-update-box {
            background-color: #FFFCEB; /* Light yellow/cream for info boxes */
            border: 1px solid #FFE88D; /* Yellow border */
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .order-status-box p, .info-box p, .live-update-box p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #0F1111;
        }
        .order-status-box strong, .info-box strong, .live-update-box strong {
            color: #007185; /* Amazon blue for highlights */
        }
        .order-status-box a, .info-box a, .live-update-box a {
            color: #007185; /* Amazon blue for links */
            text-decoration: none;
        }
        .order-status-box a:hover, .info-box a:hover, .live-update-box a:hover {
            text-decoration: underline;
        }

        .button {
            background: linear-gradient(to bottom, #F7FEFF, #F3F3F3); /* Subtle gradient */
            color: #0F1111; /* Dark text for default buttons */
            padding: 10px 20px;
            border: 1px solid #D5D9D9;
            border-radius: 3px;
            cursor: pointer;
            font-size: 1em;
            font-weight: normal;
            margin-top: 20px;
            box-shadow: 0 1px 0 rgba(255,255,255,.6) inset; /* Inner shadow for depth */
            transition: all 0.1s ease-in-out;
            display: inline-block; /* For the main submit button */
            width: auto;
        }
        .button:hover {
            background: linear-gradient(to bottom, #F3F3F3, #F1F1F1);
            border-color: #A2A6AC;
            box-shadow: 0 1px 0 rgba(255,255,255,.6) inset, 0 0 0 3px #F90; /* Orange glow on hover */
        }
        .button:active {
            background: #F0F2F2;
            box-shadow: none;
        }

        /* Primary Action Button (e.g., Send Email Anyway, Login button in modal) */
        .button.primary {
            background: linear-gradient(to bottom, #FDD681, #F0C14B); /* Amazon primary button gradient */
            border-color: #A2A6AC; /* Neutral border for primary */
            color: #111; /* Dark text */
            font-weight: bold; /* Bold text for primary */
            box-shadow: 0 1px 0 rgba(255,255,255,.4) inset; /* Inner shadow */
        }
        .button.primary:hover {
            background: linear-gradient(to bottom, #F5D36B, #E6AF2E); /* Darker on hover */
            border-color: #E77600; /* Orange border on hover */
            box-shadow: 0 0 0 3px #F90; /* Orange glow on hover */
        }
        .button.primary:active {
            background: #F0C24B;
            box-shadow: none;
        }

        /* Small action buttons (e.g., Lookup, View Last) */
        .action-button {
            background-color: #E3E6E6; /* Light gray */
            color: #0F1111; /* Dark text */
            padding: 5px 12px; /* Smaller padding */
            border: 1px solid #D5D9D9;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em; /* Smaller font */
            margin-left: 8px; /* Less margin */
            box-shadow: 0 1px 0 rgba(255,255,255,.6) inset;
            transition: all 0.1s ease-in-out;
            white-space: nowrap; /* Prevent wrap */
        }
        .action-button:hover {
            background-color: #D5D9D9;
            border-color: #A2A6AC;
            box-shadow: 0 0 0 3px #F90;
        }
        .action-button:active {
            background-color: #C0C4C8;
            box-shadow: none;
        }
        .action-button.last-order-btn { /* Specific style for last order buttons */
            margin-bottom: 5px; /* Space between buttons if they wrap */
            margin-right: 5px; /* Space between radio buttons */
        }


        .checkbox-group label {
            display: inline;
            font-weight: normal;
            font-size: 1em; /* Reset font size for checkbox labels */
            color: #0F1111;
        }
        .required-field::after {
            content: ' *';
            color: #C45500; /* Amazon orange for required indicator */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Higher z-index for modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Higher on screen */
            padding: 30px; /* More padding */
            border: 1px solid #888;
            width: 90%;
            max-width: 400px; /* Slightly narrower for login modal */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-content h2 {
            margin-top: 0;
            font-size: 24px;
            color: #0F1111;
        }
        .modal-content .form-group {
            margin-bottom: 15px; /* Adjust spacing in modal */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 30px; /* Slightly larger close button */
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #0F1111;
            text-decoration: none;
            cursor: pointer;
        }
        .contact-details-readonly input {
            background-color: #F0F2F2; /* Light grey for read-only */
            cursor: not-allowed;
        }
        .customer-details-intro {
            font-size: 0.85em;
            color: #565959; /* Muted grey */
            margin-top: 5px;
            margin-bottom: 15px;
        }
        /* Specific override for alert messages to fit Amazon style */
        .order-status-box p.error-message {
            color: #CC0000; /* Amazon error red */
            font-weight: bold;
            margin-top: 10px;
        }
        #loggedInStatus {
            font-size: 0.9em;
            color: #0F1111;
            margin-bottom: 15px;
        }
        #loggedInStatus strong {
            color: #007185; /* Amazon blue for email */
        }
        #guestLogin input {
            width: calc(100% - 200px - 8px); /* Adjust width to fit buttons */
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle; /* Align with buttons */
        }
        #guestLogin button {
            display: inline-block;
            vertical-align: middle; /* Align buttons with input */
        }
        #pastOrdersResults ul {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        #pastOrdersResults li {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #pastOrdersResults li strong {
            color: #007185;
        }

        /* Adjusted styling for the helper text directly under the order number label */
        #orderNumberLabel + p { /* Selects the <p> directly following the label with id="orderNumberLabel" */
            margin-top: 5px !important; /* Added space above */
            margin-bottom: 10px !important; /* Retained/adjusted space below */
        }

        /* NEW STYLE FOR LAST PAYMENT STATUS HELPER TEXT */
        /* Selects the <p> directly following the label for Last Payment Status */
        .form-group > label[id="lastPaymentLabel"] + p { /* Using the ID for precision */
            margin-top: 5px !important; /* Added space above */
            margin-bottom: 10px !important; /* Added space below */
        }


    </style>
</head>
<body>
    <div class="container">
        <h1>NEXT Customer Support: Submit an Enquiry</h1>
        <p class="intro">We're here to help! To get your query resolved as quickly as possible, please provide the details below.</p>

        <div class="section-header">Section 1: Your Enquiry Details</div>
        <div class="form-group">
            <label for="enquiryCategory" class="required-field">1. What is your enquiry about?</label>
            <select id="enquiryCategory" onchange="showHideSubCategory()">
                <option value="">Please Select</option>
                <option value="orderDelivery">Order & Delivery Issues</option>
                <option value="accountManagement">Account Management</option>
                <option value="returnsRefunds">Returns & Refunds</option>
                <option value="productInfo">Product Information/Queries</option>
                <option value="websiteTech">Website/App Technical Issues</option>
                <option value="paymentBilling">Payment & Billing Queries</option>
                <option value="storeRelated">Store-Related Queries</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div class="form-group" id="subCategoryGroup" style="display:none;">
            <label for="enquirySpecific" class="required-field">2. Please provide more specific details about your issue:</label>
            <select id="enquirySpecific" onchange="showHideConditionalFields()">
                </select>
        </div>

        <div class="section-header">Section 2: Your Account & Order Information</div>

        <div class="form-group" id="accountLoginSection">
            <label for="emailAddress">3. Email Address / Account Login:</label>
            <p id="loggedInStatus" style="display:none;">Logged in as: <strong>simulated.customer@next.co.uk</strong> <button class="action-button" onclick="logOut()">Change Account</button></p>
            <div id="guestLogin" style="display:block;">
                <input type="email" id="emailAddress" placeholder="your.email@example.com">
                <button type="button" class="action-button primary" onclick="openLoginModal()">Log In to your NEXT Account</button>
                <button type="button" class="action-button" onclick="continueAsGuest()">Continue as Guest</button>
            </div>
        </div>

        <div class="form-group" id="customerDetailsSection" style="display:none;">
            <label>4. Customer Details:</label>
            <p class="customer-details-intro">We'll try to fetch these from your account. Please confirm or update if needed.</p>
            <div class="checkbox-group">
                <input type="checkbox" id="fetchAccountDetails" checked onchange="toggleContactEdit()">
                <label for="fetchAccountDetails">Fetch my personal details from my account</label>
            </div>

            <div id="contactFields">
                <div class="form-group">
                    <label for="fullName">Full Name:</label>
                    <input type="text" id="fullName" placeholder="Your Full Name">
                </div>
                <div class="form-group">
                    <label for="postcode">Postcode (for account verification):</label>
                    <input type="text" id="postcode" placeholder="e.g., SW1A 0AA">
                </div>
                <div class="form-group">
                    <label for="telephoneNumber">Best Contact Telephone Number (Optional):</label>
                    <input type="tel" id="telephoneNumber" placeholder="e.g., 07912 345678">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="orderNumber" id="orderNumberLabel">5. Order Number:</label>
            <p style="font-size: 0.85em; color: #565959; margin-top: 5px; margin-bottom: 10px;">Required for all Order & Delivery and Returns queries.</p>

            <div id="lastOrdersQuickSelect" style="margin-bottom: 10px; display: none;">
                <p style="font-size: 0.9em; color: #565959; margin-right: 5px; margin-top: 0; margin-bottom: 8px;">Last 3 Orders:</p>
                </div>

            <input type="text" id="orderNumber" placeholder="Enter Order Number manually or select from above">
            <button type="button" class="action-button" onclick="lookupOrder()">Lookup Order Status</button>
            <button type="button" class="action-button" onclick="openModal('pastOrdersLookupModal')">Lookup Past Orders</button>
            <div id="orderStatusDisplay" class="order-status-box" style="display:none;">
                </div>
        </div>
        <div class="form-group">
            <label for="orderDate">6. When was the order placed? (Optional)</label>
            <input type="date" id="orderDate">
        </div>

        <div class="form-group">
            <label id="lastPaymentLabel">7. Last Payment Status:</label>
            <p style="font-size: 0.85em; color: #565959; margin-top: 5px; margin-bottom: 10px;">Check the status of your most recent payment to confirm if it was successful.</p>
            <button type="button" class="action-button" onclick="checkLastPayment()">Check Last Payment Status</button>
            <div id="lastPaymentDisplay" class="info-box" style="display:none;">
                </div>
        </div>


        <div class="section-header">Section 3: Describe Your Issue</div>
        <div class="form-group">
            <label for="issueSubject" class="required-field">8. Subject/Brief Summary of Issue:</label>
            <input type="text" id="issueSubject" placeholder="e.g., Missing item from order #123456789">
        </div>
        <div class="form-group">
            <label for="issueDetails" class="required-field">9. Please describe your issue in detail:</label>
            <textarea id="issueDetails" placeholder="Please include any relevant dates, times, specific item numbers, sizes, colours, product names, or tracking numbers to help us investigate. For faulty items, describe the fault."></textarea>
        </div>

        <div class="conditional-field" id="itemsNotReceivedFields">
            <div class="form-group">
                <label for="specificItems">10. Specific Item(s) Not Received (Item Number, Name, Size, Colour):</label>
                <textarea id="specificItems" placeholder="e.g., Item 123-456 - Blue Dress, Size 10"></textarea>
            </div>
            <div class="form-group">
                <label>11. Reorder Required?</label>
                <input type="radio" id="reorderYes" name="reorder" value="Yes"> <label for="reorderYes" class="checkbox-group">Yes</label><br>
                <input type="radio" id="reorderNo" name="reorder" value="No"> <label for="reorderNo" class="checkbox-group">No</label><br>
                <input type="radio" id="reorderDiscuss" name="reorder" value="Discuss Options"> <label for="reorderDiscuss" class="checkbox-group">Discuss Options</label>
            </div>
        </div>

        <div class="conditional-field" id="damagedFaultyFields">
            <div class="form-group">
                <label for="affectedItems">Specific Item(s) Affected (Item Number, Name, Size, Colour):</label>
                <textarea id="affectedItems" placeholder="e.g., Item 789-012 - Next Home Sofa"></textarea>
            </div>
            <div class="form-group">
                <label for="damageDescription">Please describe the damage/fault/incorrect item:</label>
                <textarea id="damageDescription"></textarea>
            </div>
        </div>
        <div class="section-header">Live Issue Updates</div>
        <p style="font-size: 0.85em; color: #565959; margin-top: -10px; margin-bottom: 10px;">Check for live updates on any active enquiries you have submitted regarding your orders or account.</p>
        <button type="button" class="button primary" onclick="getLiveIssueUpdate()">Get Live Update on This Issue</button>
        <div id="liveUpdateDisplay" class="live-update-box" style="display:none; margin-top:15px;">
            </div>


        <div class="section-header">Section 4: Supporting Documents (Optional)</div>
        <div class="form-group">
            <label for="fileUpload">12. Attach files:</label>
            <input type="file" id="fileUpload" multiple>
            <p style="font-size: 0.85em; color: #565959;">(e.g., photos of damaged items, screenshots of errors. Max file size 5MB per file, accepted formats: JPG, PNG, PDF)</p>
        </div>

        <div class="section-header">Section 5: Terms & Privacy</div>
        <div class="form-group checkbox-group">
            <input type="checkbox" id="privacyAgree" required>
            <label for="privacyAgree">I have read and agree to the <a href="#" style="color: #007185;">Privacy Policy</a>.</label>
            <p style="font-size: 0.8em; color: #565959; margin-top: 5px;">By submitting this form, you agree to our Privacy Policy and allow NEXT to use the provided information to resolve your enquiry. Your data will be handled in accordance with GDPR regulations.</p>
        </div>

        <button type="submit" class="button primary" onclick="validateAndSubmit(event)">Send Email Anyway</button>

    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('loginModal')">&times;</span>
            <h2>Sign In to Your NEXT Account</h2>
            <div class="form-group">
                <label for="loginEmail">Email address</label>
                <input type="email" id="loginEmail" placeholder="your.email@example.com">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="********">
            </div>
            <button type="button" class="button primary" onclick="processLogin()">Sign In</button>
            <p style="font-size:0.8em; color:#565959; margin-top:15px;">
                <a href="#" style="color: #007185;">Forgot your password?</a> | <a href="#" style="color: #007185;">Create a new account</a>
            </p>
        </div>
    </div>

    <div id="lastOrdersModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('lastOrdersModal')">&times;</span>
            <h2>Your Last 3 Orders</h2>
            <div id="lastOrdersContent">
                <p><strong>Order #123456789</strong> (Placed: 2025-06-20) - Status: Delivered</p>
                <ul><li>Blue Dress, Red T-shirt</li></ul>
                <p><strong>Order #987654321</strong> (Placed: 2025-06-15) - Status: Partially Delivered</p>
                <ul><li>Next Home Lamp, Coffee Table (Outstanding)</li></ul>
                <p><strong>Order #112233445</strong> (Placed: 2025-06-10) - Status: Cancelled</p>
                <ul><li>Winter Coat</li></ul>
            </div>
            <p style="font-size:0.8em; color:#565959; margin-top:15px;">Please use the relevant Order Number in the form above if your query relates to one of these.</p>
        </div>
    </div>

    <div id="pastOrdersLookupModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('pastOrdersLookupModal')">&times;</span>
            <h2>Lookup Past Orders by Date Range</h2>
            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate">
            </div>
            <button type="button" class="button primary" onclick="filterPastOrders()">Search Orders</button>
            <div id="pastOrdersResults" class="info-box" style="display:none; margin-top: 20px;">
                </div>
        </div>
    </div>


    <div id="lastPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('lastPaymentModal')">&times;</span>
            <h2>Last Payment Status</h2>
            <div id="lastPaymentModalContent">
                <p><strong>Date:</strong> 2025-06-25</p>
                <p><strong>Amount:</strong> £59.99</p>
                <p><strong>Status:</strong> <strong style="color: green;">Successful</strong></p>
                <p><strong>Related Order:</strong> #123456789</p>
                <p style="font-size:0.8em; color:#565959; margin-top:15px;">If this status is not what you expect, please proceed with your enquiry.</p>
            </div>
        </div>
    </div>


    <script>
        // --- PROTOTYPE JAVASCRIPT FOR DYNAMIC BEHAVIOR ---

        // Element references
        const enquiryCategory = document.getElementById('enquiryCategory');
        const subCategoryGroup = document.getElementById('subCategoryGroup');
        const enquirySpecific = document.getElementById('enquirySpecific');

        const orderNumberInput = document.getElementById('orderNumber');
        const orderNumberLabel = document.getElementById('orderNumberLabel');
        const orderStatusDisplay = document.getElementById('orderStatusDisplay');
        const lastOrdersQuickSelect = document.getElementById('lastOrdersQuickSelect'); // New reference

        const itemsNotReceivedFields = document.getElementById('itemsNotReceivedFields');
        const damagedFaultyFields = document.getElementById('damagedFaultyFields');

        const accountLoginSection = document.getElementById('accountLoginSection');
        const loggedInStatus = document.getElementById('loggedInStatus');
        const guestLogin = document.getElementById('guestLogin');
        const customerDetailsSection = document.getElementById('customerDetailsSection');
        const fetchAccountDetailsCheckbox = document.getElementById('fetchAccountDetails');
        const contactFields = document.getElementById('contactFields');
        const fullNameInput = document.getElementById('fullName');
        const postcodeInput = document.getElementById('postcode');
        const telephoneNumberInput = document.getElementById('telephoneNumber');
        const emailAddressInput = document.getElementById('emailAddress');

        const lastPaymentDisplay = document.getElementById('lastPaymentDisplay');
        const liveUpdateDisplay = document.getElementById('liveUpdateDisplay');

        const loginModal = document.getElementById('loginModal');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');

        const lastOrdersModal = document.getElementById('lastOrdersModal');
        const pastOrdersLookupModal = document.getElementById('pastOrdersLookupModal'); // New modal reference
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const pastOrdersResults = document.getElementById('pastOrdersResults');


        const lastPaymentModal = document.getElementById('lastPaymentModal');

        // Simulated Data (for prototype only)
        const simulatedCustomerData = {
            email: "simulated.customer@next.co.uk",
            fullName: "A. Next Customer",
            postcode: "NG1 1DP",
            phone: "07700 900123",
            password: "password123", // Dummy password for demo
            pastOrders: [ // Extended past order data with dates and various statuses
                { orderNo: '76654', date: '2025-07-05', status: 'Delivered', items: [
                    { itemNo: '987-654', name: 'Red T-shirt, Size M' },
                    { itemNo: '123-456', name: 'Blue Jeans, Size 32' },
                    { itemNo: '789-012', name: 'Next Home Lamp' }
                ]},
                { orderNo: '89764', date: '2025-07-01', status: 'In Transit', items: 'Garden Furniture Set' },
                { orderNo: '43897', date: '2025-06-28', status: 'Delayed', items: 'Kids Toy Car' },
                { orderNo: 'DELIVERED2', date: '2025-06-20', status: 'Delivered', items: [
                    { itemNo: '111-222', name: 'Shirt, Size L' },
                    { itemNo: '333-444', name: 'Socks (3-pack)' }
                ]},
                { orderNo: 'CANCELLED1', date: '2025-06-15', status: 'Cancelled', items: 'Laptop Stand' },
                { orderNo: 'UNDELIVERED2', date: '2025-06-05', status: 'Delivery Attempted', items: 'Dinner Plate Set' },
                { orderNo: 'REFUNDED1', date: '2025-05-20', status: 'Refunded', items: 'Toaster, Kettle' },
                { orderNo: 'DELIVERED3', date: '2025-05-10', status: 'Delivered', items: [
                    { itemNo: '555-666', name: 'Coat, Size S' }
                ]}
            ]
        };
        let isLoggedIn = false; // Initial state

        const subCategories = {
            'orderDelivery': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'itemNotReceived', text: 'Item(s) Not Received' },
                { value: 'damagedFaulty', text: 'Damaged/Faulty Item Received' },
                { value: 'incorrectItem', text: 'Incorrect Item Received' },
                { value: 'missingPart', text: 'Missing Part of Order' },
                { value: 'deliveryDelay', text: 'Delivery Delay/Tracking Issue' },
                { value: 'deliveryChange', text: 'Delivery Instructions/Address Change' },
                { value: 'problemCollection', text: 'Problem with Collection (e.g., Parcelshop, Store)' },
                { value: 'orderCancellation', text: 'Order Cancellation Request' },
                { value: 'otherOrder', text: 'Other Order Issue' }
            ],
            'accountManagement': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'changeDetails', text: 'Change Personal Details (address, email, phone, name)' },
                { value: 'passwordReset', text: 'Password Reset/Account Access Issue' },
                { value: 'marketingPreferences', text: 'Marketing Preferences/Unsubscribe' },
                { value: 'closeAccount', text: 'Close Account' },
                { value: 'thirdPartyAuth', text: '3rd Party Authorisation Query' },
                { value: 'otherAccount', text: 'Other Account Query' }
            ],
            'returnsRefunds': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'refundNotReceived', text: 'Refund Not Received' },
                { value: 'incorrectRefund', text: 'Incorrect Refund Amount' },
                { value: 'arrangeCollection', text: 'Arrange a Return Collection' },
                { value: 'cancelCollection', text: 'Cancel a Planned Return Collection' },
                { value: 'returnPolicy', text: 'Return Policy Query' },
                { value: 'returnsNotCredited', text: 'Returns Not Credited (e.g., store, carrier)' },
                { value: 'otherReturn', text: 'Other Return/Refund Query' }
            ],
            'productInfo': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'sizingColour', text: 'Sizing/Colour Query' },
                { value: 'materialQuery', text: 'Material/Fabric Query' },
                { value: 'stockAvailability', text: 'Stock Online Availability' },
                { value: 'storeStock', text: 'Store Stock Availability' },
                { value: 'pricingMultiBuy', text: 'Pricing/Multi Buy Query' },
                { value: 'otherProduct', text: 'Other Product Information' }
            ],
            'websiteTech': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'accessingAccount', text: 'Accessing Account' },
                { value: 'accessingApp', text: 'Accessing App' },
                { value: 'accessingWebsite', text: 'Accessing Website' },
                { value: 'addToBasket', text: 'Add to Basket Issue' },
                { value: 'checkoutIssue', text: 'Checkout Issue' },
                { value: 'websiteSlow', text: 'Website Slow/Freezing' },
                { value: 'incorrectDetail', text: 'Website Has Incorrect Item Detail' },
                { value: 'otherWebsite', text: 'Other Website/App Issue' }
            ],
            'paymentBilling': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'paymentDeclined', text: 'Payment Declined' },
                { value: 'paymentMissing', text: 'Payment Missing/Not Applied' },
                { value: 'directDebitIssue', text: 'Direct Debit Issue (Setup, Cancel, Taken)' },
                { value: 'statementQuery', text: 'Statement Explanation/Incorrect Statement' },
                { value: 'chargesQuery', text: 'Charges Query (£35 Admin, Delivery, Interest)' },
                { value: 'otherPayment', text: 'Other Payment/Billing Query' }
            ],
            'storeRelated': [
                { value: '', text: 'Please Select Specific Issue' },
                { value: 'parcelCollection', text: 'Parcel Collection Issue' },
                { value: 'staffMember', text: 'Issue with a Staff Member' },
                { value: 'storeConditions', text: 'Store Conditions/Facilities' },
                { value: 'storePurchase', text: 'Store Purchase Query' },
                { value: 'otherStore', text: 'Other Store Related Query' }
            ],
            'other': [
                 { value: '', text: 'Please Describe Below' }
            ]
        };

        // --- Functions for main category and sub-category logic ---
        function showHideSubCategory() {
            const selectedCategory = enquiryCategory.value;
            enquirySpecific.innerHTML = ''; // Clear previous options
            subCategoryGroup.style.display = 'none'; // Hide by default

            if (selectedCategory && subCategories[selectedCategory]) {
                subCategories[selectedCategory].forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    enquirySpecific.appendChild(opt);
                });
                subCategoryGroup.style.display = 'block';
            }
            showHideConditionalFields(); // Update conditional fields
            toggleOrderNumberMandatory(); // Update order number requirement
        }

        function hideAllConditionalFields() {
            itemsNotReceivedFields.style.display = 'none';
            damagedFaultyFields.style.display = 'none';
            // ... hide other conditional fields
        }

        function toggleOrderNumberMandatory() {
            const category = enquiryCategory.value;
            const isOrderRelated = ['orderDelivery', 'returnsRefunds'].includes(category);

            if (isOrderRelated) {
                orderNumberInput.setAttribute('required', 'required');
                orderNumberLabel.classList.add('required-field');
            } else {
                orderNumberInput.removeAttribute('required');
                orderNumberLabel.classList.remove('required-field');
            }
        }

        // --- Functions for Account/Personal Information (Login Logic) ---
        function openLoginModal() {
            // Auto-fill dummy details for demo
            loginEmailInput.value = simulatedCustomerData.email;
            loginPasswordInput.value = simulatedCustomerData.password;
            openModal('loginModal');
        }

        function processLogin() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;

            // Simple dummy validation
            if (email === simulatedCustomerData.email && password === simulatedCustomerData.password) {
                isLoggedIn = true;
                closeModal('loginModal'); // Close the login modal
                loggedInStatus.innerHTML = `Logged in as: <strong>${simulatedCustomerData.email}</strong> <button class="action-button" onclick="logOut()">Change Account</button>`;
                loggedInStatus.style.display = 'block';
                guestLogin.style.display = 'none';
                customerDetailsSection.style.display = 'block';
                emailAddressInput.value = simulatedCustomerData.email; // Also update the main form's email field
                fetchAccountDetailsCheckbox.checked = true;
                toggleContactEdit(); // Pre-fill and make read-only
                populateLastOrders(); // Populate quick select orders after login
                alert("Login successful! Your details have been pre-filled.");
            } else {
                alert("Invalid email or password. Please try again. (Hint: " + simulatedCustomerData.email + " / " + simulatedCustomerData.password + ")");
            }
        }

        function logOut() {
            isLoggedIn = false;
            loggedInStatus.style.display = 'none';
            guestLogin.style.display = 'block';
            customerDetailsSection.style.display = 'block'; // Keep customer details section visible for guest input
            fetchAccountDetailsCheckbox.checked = false;
            toggleContactEdit(); // Clears pre-filled fields and makes them editable
            emailAddressInput.value = ''; // Clear email input on the main form
            loginEmailInput.value = ''; // Clear login modal email
            loginPasswordInput.value = ''; // Clear login modal password
            // Clear last orders quick select on logout
            lastOrdersQuickSelect.innerHTML = ''; // Clear contents entirely
            lastOrdersQuickSelect.style.display = 'none'; // Hide the quick select section
            alert("You have been logged out.");
        }

        function continueAsGuest() {
             isLoggedIn = false; // Ensure not logged in
             customerDetailsSection.style.display = 'block';
             fetchAccountDetailsCheckbox.checked = false;
             toggleContactEdit(); // Ensure fields are editable
             guestLogin.style.display = 'none'; // Hide login/guest options
             // Quick select orders remain hidden or cleared for guests unless they logged in before
             lastOrdersQuickSelect.innerHTML = ''; // Clear contents entirely
             lastOrdersQuickSelect.style.display = 'none'; // Hide the quick select section
        }

        function toggleContactEdit() {
            const shouldFetch = fetchAccountDetailsCheckbox.checked && isLoggedIn;
            const inputs = contactFields.querySelectorAll('input');

            if (shouldFetch) {
                fullNameInput.value = simulatedCustomerData.fullName;
                postcodeInput.value = simulatedCustomerData.postcode;
                telephoneNumberInput.value = simulatedCustomerData.phone;
                inputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                    input.classList.add('contact-details-readonly');
                });
            } else {
                // Only clear if coming from a "fetched" state and now unchecked
                if (isLoggedIn) { // If logged in, but user unchecked fetch
                    fullNameInput.value = '';
                    postcodeInput.value = '';
                    telephoneNumberInput.value = '';
                }
                // Also ensures they are editable if not fetching or not logged in
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.classList.remove('contact-details-readonly');
                });
            }
        }

        // --- Functions for Information Fetching ---
        function populateLastOrders() {
            if (!isLoggedIn) {
                lastOrdersQuickSelect.style.display = 'none';
                return;
            }

            lastOrdersQuickSelect.style.display = 'block';
            // Start with the "Last 3 Orders:" text
            let radioButtonsHtml = '<p style="font-size: 0.9em; color: #565959; margin-right: 5px; margin-top: 0; margin-bottom: 8px;">Last 3 Orders:</p>';
            
            // Sort by date descending and take top 3
            const sortedOrders = [...simulatedCustomerData.pastOrders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 0; i < Math.min(3, sortedOrders.length); i++) {
                const order = sortedOrders[i];
                // Display only order number, status, and placed date
                radioButtonsHtml += `
                    <label class="radio-label" style="display: block; margin-bottom: 5px; font-weight: normal;">
                        <input type="radio" name="quickOrderSelect" value="${order.orderNo}" onclick="selectQuickOrder('${order.orderNo}')" style="margin-right: 5px;">
                        <strong>${order.orderNo}</strong> (Status: ${order.status}, Placed: ${order.date})
                    </label>
                `;
            }
            lastOrdersQuickSelect.innerHTML = radioButtonsHtml;
        }

        function selectQuickOrder(orderNo) {
            orderNumberInput.value = orderNo;
            lookupOrder(); // Automatically look up status when an order is selected
        }


        function lookupOrder() {
            const orderNum = orderNumberInput.value.trim();
            let displayContent = '';

            // Helper to format items array into HTML list (with specified status, default 'Delivered')
            const formatItemsList = (items, statusOverride = 'Delivered') => {
                if (Array.isArray(items)) {
                    let listHtml = '<p>Items in Order:</p><ul>';
                    items.forEach(item => {
                        listHtml += `<li>Item ${item.itemNo} - ${item.name}: ${statusOverride}</li>`;
                    });
                    listHtml += '</ul>';
                    return listHtml;
                }
                return `<p>Items: ${items}</p>`; // Fallback if not an array (e.g., 'Garden Furniture Set')
            };

            // Find the order details from simulated data
            const orderDetails = simulatedCustomerData.pastOrders.find(order => order.orderNo === orderNum);

            // Handle specific case for order 76654 as requested by the user
            if (orderNum === '76654') {
                displayContent = `
                    <p><strong>Order Status for ${orderNum}:</strong></p>
                    <p>Status: <strong>Delivered</strong></p>
                    ${formatItemsList(simulatedCustomerData.pastOrders.find(o => o.orderNo === '76654').items, 'Delivered')}
                    <p>Delivered on: 2025-07-07</p>
                    <p class="error-message">Our records show this item as 'Delivered'. If you have not received it, please proceed with your enquiry and include any delivery instructions you provided.</p>
                `;
            }
            // Handle specific case for order 43897
            else if (orderNum === '43897') {
                displayContent = `
                    <p><strong>Order Status for ${orderNum}:</strong></p>
                    <p>Status: <strong>Delayed</strong></p>
                    <p>Items: Kids Toy Car</p>
                    <p>Placed on: 2025-06-28</p>
                    <p>Expected Delivery: <strong>30th July 2025</strong></p>
                    <p>Tracking: <a href="#" target="_blank" style="color: #007185;">Track with Evri (${orderNum}TRACK)</a></p>
                `;
            }
            // Fallback to generic/simulated lookup for other orders
            else if (orderNum && orderDetails) {
                let statusColor = '';
                if (orderDetails.status === 'Delivered' || orderDetails.status === 'Refunded') {
                    statusColor = 'green';
                } else if (orderDetails.status === 'Cancelled') {
                    statusColor = 'red';
                } else { // In Transit, Delayed, Delivery Attempted etc.
                    statusColor = 'orange';
                }

                displayContent = `
                    <p><strong>Order Status for ${orderNum}:</strong></p>
                    <p>Status: <strong style="color: ${statusColor};">${orderDetails.status}</strong></p>
                    ${formatItemsList(orderDetails.items, orderDetails.status)} <p>Placed on: ${orderDetails.date}</p>
                    ${(orderDetails.status === 'In Transit' || orderDetails.status === 'Delayed' || orderDetails.status === 'Delivery Attempted') ? 
                        `<p>Expected Delivery: <strong>July 10, 2025</strong></p><p>Tracking: <a href="#" target="_blank" style="color: #007185;">Track with Evri (${orderNum}TRACK)</a></p>` : ''}
                `;
                // Add the "Our records show this item as 'Delivered'" message for specifically delivered status
                if (orderDetails.status === 'Delivered') {
                     displayContent += `<p class="error-message">Our records show this item as 'Delivered'. If you have not received it, please proceed with your enquiry and include any delivery instructions you provided.</p>`;
                }

            } else if (orderNum) {
                displayContent = `<p class="error-message">Order #${orderNum} not found in our records. Please check the number and try again.</p>`;
            }
            
            if (displayContent) {
                orderStatusDisplay.innerHTML = displayContent;
                orderStatusDisplay.style.display = 'block';
            } else {
                orderStatusDisplay.style.display = 'none';
                alert('Please enter an Order Number or select one to look up its status.');
            }
        }

        // New function to filter past orders by date range
        function filterPastOrders() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            let resultsHtml = '<ul>';
            let ordersFound = 0;

            if (!startDate || !endDate) {
                pastOrdersResults.innerHTML = '<p class="error-message">Please select both a start and end date.</p>';
                pastOrdersResults.style.display = 'block';
                return;
            }

            const start = new Date(startDate + 'T00:00:00'); // Add time to avoid timezone issues
            const end = new Date(endDate + 'T23:59:59');     // Add time to cover full end day

            if (start > end) {
                pastOrdersResults.innerHTML = '<p class="error-message">Start date cannot be after end date.</p>';
                pastOrdersResults.style.display = 'block';
                return;
            }

            const filteredOrders = simulatedCustomerData.pastOrders.filter(order => {
                const orderDate = new Date(order.date + 'T12:00:00'); // Midday to handle timezone consistently
                return orderDate >= start && orderDate <= end;
            }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort latest first

            if (filteredOrders.length > 0) {
                filteredOrders.forEach(order => {
                    const itemsSummary = Array.isArray(order.items) ? order.items.map(item => item.name).join(', ') : order.items;
                    resultsHtml += `<li><strong>Order #${order.orderNo}</strong> (Placed: ${order.date}) - Status: ${order.status}<br>Items: ${itemsSummary}</li>`;
                    ordersFound++;
                });
                resultsHtml += '</ul>';
            } else {
                resultsHtml = '<p>No orders found in the selected date range.</p>';
            }

            pastOrdersResults.innerHTML = resultsHtml;
            pastOrdersResults.style.display = 'block';
        }


        function checkLastPayment() {
            // Check if logged in for real data, otherwise show dummy
            if (isLoggedIn) {
                // In a real app, fetch real data
                openModal('lastPaymentModal');
            } else {
                alert("Please log in to view your real payment history, or continue as guest to view simulated data.");
                openModal('lastPaymentModal'); // Show dummy data anyway for demo
            }
        }

        function getLiveIssueUpdate() {
            const issueSubject = document.getElementById('issueSubject').value.trim();
            const orderNum = orderNumberInput.value.trim();

            let updateMessage = "<p>No active updates found for the current details provided.</p>";
            const currentTime = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedTime = currentTime.toLocaleString('en-GB', options);

            // Updated dummy conditions to match new dummy data examples
            if (orderNum === "89764") { // Corresponds to UNDELIVERED1 (In Transit)
                updateMessage = `
                    <p><strong>Update for Order #${orderNum} - Garden Furniture:</strong></p>
                    <p>Your delivery is currently 'In Transit' and expected within the next 24 hours. If not received by then, please contact us.</p>
                    <p style="font-size: 0.8em; color: #565959;">Last updated: ${formattedTime}</p>
                `;
            } else if (orderNum === "43897") { // Corresponds to DELAYED1
                 updateMessage = `
                    <p><strong>Update for Order #${orderNum} - Kids Toy Car:</strong></p>
                    <p>We apologize for the delay. Your order has been rerouted due to unforeseen logistics issues. New estimated delivery: July 12, 2025.</p>
                    <p style="font-size: 0.8em; color: #565959;">Last updated: ${formattedTime}</p>
                `;
            } else if (orderNum === "76654" && issueSubject.toLowerCase().includes("missing")) { // Corresponds to DELIVERED1, specifically when user also mentions "missing"
                updateMessage = `
                    <p><strong>Update for Order #${orderNum} - Missing Delivered Item:</strong></p>
                    <p>Your query regarding the delivered but missing item is being investigated. Please allow 1-2 business days for a response.</p>
                    <p style="font-size: 0.8em; color: #565959;">Last updated: ${formattedTime}</p>
                `;
            } else if (enquiryCategory.value === "accountManagement" && isLoggedIn) {
                updateMessage = `
                    <p><strong>Update for Account Details Change:</strong></p>
                    <p>Your request to update your address has been processed successfully. This update should reflect in your account within 24 hours.</p>
                    <p style="font-size: 0.8em; color: #565959;">Last updated: ${formattedTime}</p>
                `;
            } else if (issueSubject.toLowerCase().includes("payment") || enquiryCategory.value === "paymentBilling") {
                updateMessage = `
                    <p><strong>Update for Payment Issue:</strong></p>
                    <p>Your payment query is currently being reviewed. Please allow 1-2 business days for a response. We will contact you directly if further information is required.</p>
                    <p style="font-size: 0.8em; color: #565959;">Last updated: ${formattedTime}</p>
                `;
            }

            liveUpdateDisplay.innerHTML = updateMessage;
            liveUpdateDisplay.style.display = 'block';
        }


        // --- Modal Functions ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                // Close modal only if click is directly on the overlay, not on modal content
                const modalContent = event.target.querySelector('.modal-content');
                if (modalContent && !modalContent.contains(event.target)) {
                    event.target.style.display = 'none';
                }
            }
        }

        // --- Form Submission Validation (Basic) ---
        function validateAndSubmit(event) {
            const category = enquiryCategory.value;
            const specificIssue = enquirySpecific.value;
            const orderNum = orderNumberInput.value.trim();
            const issueSubject = document.getElementById('issueSubject').value.trim();
            const issueDetails = document.getElementById('issueDetails').value.trim();
            const privacyChecked = document.getElementById('privacyAgree').checked;
            const emailInputVal = emailAddressInput.value.trim();

            // Basic validation for mandatory fields
            if (emailInputVal === '' && !isLoggedIn) {
                alert('Please provide your email address to submit the form, or log in.');
                emailAddressInput.focus();
                event.preventDefault(); return;
            }

            if (category === '') {
                alert('Please select your enquiry category.');
                event.preventDefault(); return;
            }
            if (specificIssue === '') {
                alert('Please select more specific details about your issue.');
                event.preventDefault(); return;
            }
            if (['orderDelivery', 'returnsRefunds'].includes(category) && orderNum === '') {
                alert('Order Number is mandatory for this type of enquiry.');
                event.preventDefault(); return;
            }
            if (issueSubject === '') {
                alert('Please provide a brief summary of your issue.');
                issueSubject.focus();
                event.preventDefault(); return;
            }
            if (issueDetails === '') {
                alert('Please describe your issue in detail.');
                issueDetails.focus();
                event.preventDefault(); return;
            }
            if (!privacyChecked) {
                alert('You must agree to the Privacy Policy to submit your enquiry.');
                event.preventDefault(); return;
            }

            alert('Form submitted successfully (simulated)! Thank you for your enquiry. We will be in touch shortly.');
            event.preventDefault();
        }

        // --- Initial setup on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure initial state is logged out and fields editable
            isLoggedIn = false;
            loggedInStatus.style.display = 'none';
            guestLogin.style.display = 'block';
            customerDetailsSection.style.display = 'block';
            fetchAccountDetailsCheckbox.checked = false;
            toggleContactEdit(); // Set fields to editable

            emailAddressInput.value = ''; // Ensure main form email is blank on load
            // The openLoginModal function now handles auto-filling for its specific inputs

            toggleOrderNumberMandatory(); // Set initial order number requirement
            showHideSubCategory(); // Initialize sub-category dropdown

            // Initially hide quick select orders for guests
            lastOrdersQuickSelect.style.display = 'none';
        });

    </script>
</body>
</html>